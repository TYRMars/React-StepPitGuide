# React è™šæ‹ŸDOMæ€è€ƒ

## React è™šæ‹ŸDOMæ€è€ƒ

### 1.è™šæ‹ŸDOM+components+ç”Ÿå‘½å‘¨æœŸçš„è”ç³»

#### React-è™šæ‹ŸDOMåˆ†æ

* ä»æµè§ˆå™¨æ¸²æŸ“è§’åº¦è¯´Reactä¸ºä»€ä¹ˆä¼šä½¿ç”¨è™šæ‹ŸDOM
* è™šæ‹ŸDOMçš„åŸç†
* ä»¥ä¸‹æ˜¯ç»¼å„ä¸ªèµ„æ–™åçš„ä¸ªäººç†è§£ï¼Œå¦‚æœ‰é—®é¢˜è¯·æŒ‡å‡º

**ä»æµè§ˆå™¨æ¸²æŸ“è§’åº¦è¯´React**

* é¦–å…ˆè¦çŸ¥é“`React`æ˜¯ç”±`Facebook`å¯¹ç°æœ‰ä¸šåŠ¡è¿›è¡Œæ”¹è¿›æå‡çš„æ—¶å€™æå‡ºæ¥çš„ã€‚`DOM`æ˜¯å¾ˆæ…¢çš„ï¼Œå…¶å…ƒç´ éå¸¸åºå¤§ï¼Œé¡µé¢çš„æ€§èƒ½é—®é¢˜é²œæœ‰ç”±JSå¼•èµ·çš„ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯ç”±DOMæ“ä½œå¼•èµ·çš„ã€‚æ‰€æœ‰`Facebook`åœ¨`React`ä¸­å¼•å…¥äº†é¡µé¢UIç»„ä»¶åŒ–ã€è™šæ‹ŸDOMï¼Œæ¥è§£å†³è¿™äº›é—®é¢˜ã€‚
* React.jså¯¹å¸¸ç”¨ç»„å»ºè¿›è¡Œäº†ä¼˜åŒ–,å®ƒç®—æ˜¯ä¸€ä¸ªcomponentsç»„ä»¶åº“ã€‚ReactDom.jsæ˜¯Reactç‰ˆæœ¬ä¼˜åŒ–çš„è™šæ‹ŸDOM
* å¦‚æœè¦æ¸²æŸ“åˆ°æœ€åDisplayæ˜¾ç¤ºï¼Œéœ€è¦ç»è¿‡å¾ˆé•¿è¿‡ç¨‹ï¼Œæµè§ˆå™¨ä¼šå…ˆæ”¶é›†åˆ°HTMLå’ŒCSSï¼Œå¯¹HTMLå’ŒCSSåˆ†åˆ«ç»è¿‡Parserå‰–æå™¨ï¼Œåˆ†åˆ«ç”ŸæˆDOMTreeå’ŒCSSRuleTreeã€‚ DOMå’ŒCSSOMåˆå¹¶åç”ŸæˆRender Treeã€‚
* React.jså¸Œæœ›ç”¨JSXè¯­è¨€å†™å‡ºHTMLå’ŒCSSè¿˜æœ‰é¡µé¢é€»è¾‘æ··åˆåœ¨ä¸€èµ·æˆä¸ºä¸€ä¸ªcomponentï¼Œï¼ˆåœ¨reactç¼–å†™çš„æ—¶å€™å°±æ˜¯é€šè¿‡classç»§æ‰¿çš„react.componentè¿™ä¸ªç±»ï¼‰ï¼Œç›´æ¥é€šè¿‡JSå¯¹è±¡çš„å½¢å¼ç”Ÿæˆäº†`ReactRenderTree`ã€‚
* æˆ‘è§‰å¾—è¿™æ˜¯åŸå‹é“¾çš„ğŸŒ²æ ‘çŠ¶ç»“æ„åŒ–ï¼Œ`ReactRenderTree`ï¼ˆReactç”Ÿå‘½å‘¨æœŸï¼‰åœ¨é€šè¿‡è™šæ‹ŸDOMï¼ˆReactDom.jsï¼‰ï¼Œé¦–æ¬¡ç”Ÿæˆç»™åˆ°æµè§ˆå™¨çš„æ—¶å€™å°±æ˜¯ä¸€ä¸ªæµè§ˆå™¨ç›´æ¥å¯ä»¥è¯†åˆ«çš„RenderTreeï¼Œæµè§ˆå™¨ç›´æ¥Paintingï¼Œç„¶åæ˜¾ç¤ºåœ¨é¡µé¢ä¸Šã€‚
* è™šæ‹Ÿçš„DOMçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå¯¹å¤æ‚çš„æ–‡æ¡£DOMç»“æ„ï¼Œæä¾›ä¸€ç§æ–¹ä¾¿çš„å·¥å…·ï¼Œè¿›è¡Œæœ€å°åŒ–åœ°DOMæ“ä½œ

**å½“éœ€è¦é‡æ’æ—¶Reflow**

* `React`ä¼šé€šè¿‡è™šæ‹Ÿ`DOM`å¯¹æ–°ç”Ÿæˆçš„DOMå’ŒåŸæ¥çš„DOMæ ‘è¿›è¡Œå¯¹æ¯”ï¼Œæ”¹å˜é¡µé¢

**è™šæ‹ŸDOMçš„åŸç†**

* è™šæ‹Ÿ`DOM`ç±»ä¼¼äºï¼ˆè‡ªåŠ¨åŒ–æ§åˆ¶çš„ç½‘é¡µç”Ÿæˆå™¨ï¼‰é€šè¿‡`Node`èŠ‚ç‚¹`render`ç”Ÿæˆç›¸å¯¹åº”çš„ç½‘é¡µï¼Œä½†ä¸»è¦åŠŸèƒ½åœ¨äºç½‘é¡µæ›´æ–°æ—¶å€™ï¼Œå¯¹äºNodeèŠ‚ç‚¹çš„æ›´æ–°ï¼Œè™šæ‹ŸDOMä¼šæ¯”è¾ƒä¸¤æ£µDOMæ ‘çš„åŒºåˆ«ï¼Œä¿è¯æœ€å°åŒ–çš„DOMæ“ä½œï¼Œä½¿å¾—æ‰§è¡Œæ•ˆç‡å¾—åˆ°ä¿è¯ã€‚
* ç”±äºè®¡ç®—ä¸¤æ£µæ ‘çš„å¸¸è§„ç®—æ³•æ˜¯`O(n^3)`çº§åˆ«ï¼ŒDOMç»“æ„è¾¾åˆ°æˆç™¾ä¸ªèŠ‚ç‚¹åœ¨å®é™…é¡¹ç›®ä¸­å¾ˆæ­£å¸¸ï¼Œæ‰€ä»¥éœ€è¦ä¼˜åŒ–æ·±åº¦éå†çš„ç®—æ³•ã€‚

**React diff ç­–ç•¥**

* `Web UI` ä¸­ `DOM` èŠ‚ç‚¹è·¨å±‚çº§çš„ç§»åŠ¨æ“ä½œç‰¹åˆ«å°‘ï¼Œå¯ä»¥å¿½ç•¥ä¸è®¡ã€‚
* æ‹¥æœ‰ç›¸åŒç±»çš„ä¸¤ä¸ªç»„ä»¶å°†ä¼šç”Ÿæˆç›¸ä¼¼çš„æ ‘å½¢ç»“æ„ï¼Œæ‹¥æœ‰ä¸åŒç±»çš„ä¸¤ä¸ªç»„ä»¶å°†ä¼šç”Ÿæˆä¸åŒçš„æ ‘å½¢ç»“æ„ã€‚
* å¯¹äºåŒä¸€å±‚çº§çš„ä¸€ç»„å­èŠ‚ç‚¹ï¼Œå®ƒä»¬å¯ä»¥é€šè¿‡å”¯ä¸€ id è¿›è¡ŒåŒºåˆ†ã€‚
* åŸºäºä»¥ä¸Šä¸‰ä¸ªå‰æç­–ç•¥ï¼Œ`React` åˆ†åˆ«å¯¹ `tree diff`ã€`component diff` ä»¥åŠ `element diff` è¿›è¡Œç®—æ³•ä¼˜åŒ–ï¼Œäº‹å®ä¹Ÿè¯æ˜è¿™ä¸‰ä¸ªå‰æç­–ç•¥æ˜¯åˆç†ä¸”å‡†ç¡®çš„ï¼Œå®ƒä¿è¯äº†æ•´ä½“ç•Œé¢æ„å»ºçš„æ€§èƒ½ã€‚
* Reactçš„å±€é™æ€§ï¼Œä¸é€‚åˆæ¯ä¸ªé¡µé¢ä½¿ç”¨ç‡å¾ˆä½ç½‘ç«™ï¼Œï¼ˆæ¯ä¸ªé¡µé¢é¡µé¢é€»è¾‘ä¸åŒï¼‰;

[![](https://camo.githubusercontent.com/289a50d2838a83515ce740ad40e493ea009e4e8b/68747470733a2f2f706963332e7a68696d672e636f6d2f37346138366662636338626234616437346531396237326137326232366335365f722e706e67)](https://camo.githubusercontent.com/289a50d2838a83515ce740ad40e493ea009e4e8b/68747470733a2f2f706963332e7a68696d672e636f6d2f37346138366662636338626234616437346531396237326137326232366335365f722e706e67)

[çŸ¥ä¹-React æºç å‰–æç³»åˆ— ï¼ ä¸å¯æ€è®®çš„ react diff](https://zhuanlan.zhihu.com/p/20346379)

**React-ç”Ÿå‘½å‘¨æœŸ**

* `ReactNode`èŠ‚ç‚¹æ˜¯ç”±JSåˆ¶ä½œè€Œæˆï¼Œæœ¬èº«æ˜¯æ­»çš„ï¼Œè¦èµ‹äºˆå…¶æ´»æ€§ï¼Œå°±éœ€è¦åƒç°å®äº‹ç‰©ä¸€æ ·æœ‰ç”Ÿå‘½å‘¨æœŸã€‚é€šè¿‡ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œæ¥é—´æ¥æ§åˆ¶äº‹ä»¶ä¸DOMçš„æ“ä½œï¼ï¼ï¼
* ä¸ºäº†æ–¹ä¾¿è¿™æ ·çš„æ“ä½œReactæœ‰äº†JSXè¿™ç§è¯­æ³•èåˆäº†`HTML`å’Œ`CSS`ï¼Œä¸éš¾çœ‹å‡ºä½¿ç”¨è¿™ç§è¯­æ³•èƒ½æå¤§çš„æé«˜Reactæ€§èƒ½ï¼ˆä»æµè§ˆå™¨æ¸²æŸ“çš„è§’åº¦ï¼‰

[![](https://camo.githubusercontent.com/2d82a2e67c415a05b33005d0f500c679d34b2639/687474703a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f313831343335342d346266363265353435353361333262372e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/2d82a2e67c415a05b33005d0f500c679d34b2639/687474703a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f313831343335342d346266363265353435353361333262372e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

## 2.Virtual DOM ä¸ React Diffç®—æ³•

## ![](../.gitbook/assets/å¾®ä¿¡æˆªå›¾_20180102170018.png)

#### Example\([virtual dom](https://github.com/Matt-Esch/virtual-dom#example)\)

```javascript
var h = require('virtual-dom/h');
var diff = require('virtual-dom/diff');
var patch = require('virtual-dom/patch');
var createElement = require('virtual-dom/create-element');

// 1: Create a function that declares what the DOM should look like
// 1ï¼šåˆ›å»ºä¸€ä¸ªrenderå‡½æ•°ï¼Œå£°æ˜äº†DOMåº”è¯¥æ˜¯ä»€ä¹ˆæ ·å­
function render(count)  {
    return h('div', {
        style: {
            textAlign: 'center',
            lineHeight: (100 + count) + 'px',
            border: '1px solid red',
            width: (100 + count) + 'px',
            height: (100 + count) + 'px'
        }
    }, [String(count)]);
}

// 2: Initialise the document
// 2ï¼šåˆå§‹åŒ–ä¼ å…¥çš„å‚æ•°ï¼Œä¸»è¦æ˜¯é¡µé¢éœ€è¦æ”¹å˜å¾—æ•°æ®
var count = 0;      // We need some app data. Here we just store a count.

var tree = render(count);               // We need an initial tree å®ä¾‹åŒ–ä¸€ä¸ªæ ‘èŠ‚ç‚¹åœ¨å†…å­˜å½“ä¸­ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å®šä¹‰çš„è¿™ä¸ªrenderæ ‘
var rootNode = createElement(tree);     // Create an initial root DOM node ... é€šè¿‡CreateElementåˆ›å»ºä¸€ä¸ªçœŸå®çš„DOMèŠ‚ç‚¹æ’å…¥åˆ°DOMç»“æ„ä¸­
document.body.appendChild(rootNode);    // ... and it should be in the document æŠŠèŠ‚ç‚¹åµŒå…¥åˆ°é¡µé¢å½“ä¸­

// 3: Wire up the update logic
// 3ï¼šå†™ä¸€ä¸ªå‡çº§æ ‘çš„è¿‡ç¨‹
setInterval(function () {
      count++;

      var newTree = render(count);//æ–°çš„ç”Ÿæˆæ ‘
      var patches = diff(tree, newTree);//diffç®—æ³•å¯¹æ¯”å‡ºä¿®æ”¹çš„é¡µé¢
      rootNode = patch(rootNode, patches);//patchæ›´æ”¹é¡µé¢
      tree = newTree;//æ ‘èµ‹å€¼æˆæ–°æ ‘
}, 1000);
```

